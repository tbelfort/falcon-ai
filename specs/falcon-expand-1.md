# Falcon Expansion Plan v1

**Status**: Draft
**Created**: 2026-01-24
**Source**: docs/design/falcon-new-vision.md

---

## Executive Summary

This plan expands falcon-ai from a pattern-based guardrail system into a complete AI agent orchestration platform. The expansion replaces Linear with a custom project management system built specifically for multi-agent development workflows.

### Core Goals
1. Replace Linear with a custom system optimized for AI agent workflows
2. Build orchestration layer to manage agent lifecycle and task progression
3. Create agent management infrastructure (folders, git repos, state)
4. Enable humans to configure and monitor multi-agent pipelines

---

## Part 1: Custom Project Management System (Falcon PM)

### 1.1 Tech Stack Decision

**Recommended Stack** (optimized for LLM code generation):

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Frontend | React + TypeScript | LLMs have extensive training on React; good type safety |
| UI Framework | Tailwind CSS | Utility-first, easy for LLMs to generate |
| State Management | Zustand | Simple, minimal boilerplate |
| Backend | Node.js + Express | Matches frontend language, simple HTTP API |
| Database | SQLite (file-based) | No external dependencies, easy to backup/inspect |
| ORM | Drizzle | Type-safe, lightweight, good LLM support |

**Why SQLite over Postgres:**
- Zero setup, runs anywhere
- Easy backup (just copy the file)
- Sufficient for single-team use
- Can migrate to Postgres later if needed

### 1.2 Data Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Project   â”‚â”€â”€â”€â”€<â”‚    Issue    â”‚â”€â”€â”€â”€<â”‚   Comment   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Document   â”‚     â”‚   Label     â”‚     â”‚    User     â”‚
â”‚ (spec/ctx)  â”‚     â”‚             â”‚     â”‚(agent/human)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚StageMessage â”‚
                    â”‚(for future  â”‚
                    â”‚ stage agent)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Core Entities

**Project**
- id, name, slug, description
- github_repo_url
- default_workflow_config (JSON - model assignments)
- created_at, updated_at

**Issue**
- id, project_id, title, description
- branch_name (generated by haiku)
- current_stage (enum: backlog, todo, context_pack, spec, implement, pr_review, testing, doc_review, merge_ready, done)
- state (enum: agent_ready, agent_working, needs_human_attention)
- workflow_config (JSON - model overrides)
- assigned_agent_id, assigned_human_id
- created_at, updated_at

**Issue Attributes** (boolean flags)
- has_context_pack, needs_context_pack
- has_spec, needs_spec
- has_tests, needs_tests

**Label** (built-in set)
- bugs, data, docs, foundation, feature, migration, performance, refactor, security, test, ux

**User**
- id, name, type (agent | human)
- agent_config (JSON - for agents: model, provider)
- created_at

**Document**
- id, project_id, issue_id (nullable)
- type (context_pack | spec | ai_doc)
- title, content, file_path
- created_at, updated_at

**StageMessage** (inter-stage communication)
- id, issue_id
- from_stage, to_stage
- message
- created_at

**Comment**
- id, issue_id, user_id
- content
- created_at

**IssueDependency**
- issue_id, depends_on_issue_id

### 1.3 Kanban Board UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Project: falcon-ai                                                    [Settings]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backlog â”‚  Todo   â”‚  Context  â”‚  Spec  â”‚Implementa â”‚PR Reviewâ”‚  Test  â”‚  Done  â”‚
â”‚         â”‚         â”‚   Pack    â”‚        â”‚   tion    â”‚         â”‚        â”‚        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚           â”‚         â”‚        â”‚ â”Œâ”€â”€â”€â”€â” â”‚
â”‚ â”‚#123 â”‚ â”‚ â”‚#456 â”‚ â”‚ â”‚#789   â”‚ â”‚        â”‚           â”‚         â”‚        â”‚ â”‚#111â”‚ â”‚
â”‚ â”‚     â”‚ â”‚ â”‚     â”‚ â”‚ â”‚ğŸ¤–opus â”‚ â”‚        â”‚           â”‚         â”‚        â”‚ â”‚    â”‚ â”‚
â”‚ â”‚feat â”‚ â”‚ â”‚bug  â”‚ â”‚ â”‚       â”‚ â”‚        â”‚           â”‚         â”‚        â”‚ â”‚doneâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚           â”‚         â”‚        â”‚ â””â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚         â”‚           â”‚        â”‚           â”‚         â”‚        â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

State indicators: ğŸŸ¢ agent_ready  ğŸ¤– agent_working  ğŸ‘¤ needs_human
```

### 1.4 Document Manager

Located in sidebar or dedicated tab:
- Tree view by project/issue
- Types: Context Packs, Specs, AI Docs
- Attach documents to issues
- Index view for ai_docs (`.falcon/ai_docs/INDEX.md`)

### 1.5 User/Agent Management

- Add humans manually
- Agents auto-created on first assignment
- Agent names from `FALCON_AGENT_NAME` env variable
- View agent activity logs

---

## Part 2: Orchestration Dashboard

### 2.1 Active Work Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Active Agents                                              [Refresh]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ğŸ¤– opus-1      Issue #789    Stage: Context Pack    â±ï¸ 4m 32s   â”‚  â”‚
â”‚ â”‚    Status: Running    [View Debug Output]                        â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ğŸ¤– codex-1     Issue #456    Stage: Implement       â±ï¸ 12m 08s  â”‚  â”‚
â”‚ â”‚    Status: Running    [View Debug Output]                        â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Available Agents: sonnet-1, haiku-1                                   â”‚
â”‚ Queue: 3 issues waiting                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Model Configuration Panel

Per-issue or per-project defaults:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Workflow Configuration: Issue #789                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage                â”‚ Model                    â”‚ Provider          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Context Pack         â”‚ opus-4.5        [â–¼]     â”‚ Claude Code       â”‚
â”‚ Context Pack Review  â”‚ gpt-5.2-high    [â–¼]     â”‚ Codex             â”‚
â”‚ Spec Creation        â”‚ opus-4.5        [â–¼]     â”‚ Claude Code       â”‚
â”‚ Spec Review          â”‚ sonnet-4.5      [â–¼]     â”‚ Claude Code       â”‚
â”‚ Implementation       â”‚ codex-5.2-xhigh [â–¼]     â”‚ Codex             â”‚
â”‚ PR Review - Scout 1  â”‚ opus-4.5        [â–¼]     â”‚ Claude Code       â”‚
â”‚ PR Review - Scout 2  â”‚ gpt-5.2         [â–¼]     â”‚ Codex             â”‚
â”‚ PR Review - Judge    â”‚ opus-4.5        [â–¼]     â”‚ Claude Code       â”‚
â”‚ PR Review - Orch     â”‚ sonnet-4.5      [â–¼]     â”‚ Claude Code       â”‚
â”‚ Fixer               â”‚ opus-4.5        [â–¼]     â”‚ Claude Code       â”‚
â”‚ Testing             â”‚ sonnet-4.5      [â–¼]     â”‚ Claude Code       â”‚
â”‚ Doc Review          â”‚ haiku-4.5       [â–¼]     â”‚ Claude Code       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Presets: [Full Pipeline â–¼]  [Save as New Preset]                   â”‚
â”‚                                                                     â”‚
â”‚                           [Start Issue]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 PR Review Dashboard

For human review of agent findings:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PR Review: Issue #789 - Add authentication                         â”‚
â”‚ Branch: feat/789-add-auth  PR #42                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Findings (12 total)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Approved (8)  â”‚  âŒ Dismissed (2)  â”‚  â³ Pending (2)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â³ SECURITY - SQL injection in login.ts:45                         â”‚
â”‚    Scout: opus-1  Judge: Confirmed                                 â”‚
â”‚    [Approve] [Dismiss with reason...]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â³ STYLE - Inconsistent naming in utils.ts                         â”‚
â”‚    Scout: gpt-5.2  Judge: Confirmed                                â”‚
â”‚    [Approve] [Dismiss with reason...]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚ [Launch Fixer] (requires all pending reviewed)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 3: Agent Infrastructure

### 3.1 Directory Structure

```
~/.falcon/
â”œâ”€â”€ config.yaml              # Global config (GitHub token, subscriptions)
â”œâ”€â”€ projects/
â”‚   â””â”€â”€ falcon-ai/
â”‚       â”œâ”€â”€ config.yaml      # Project config
â”‚       â”œâ”€â”€ primary/         # Large files (symlinked to agents)
â”‚       â”œâ”€â”€ agents/
â”‚       â”‚   â”œâ”€â”€ opus-1/      # Full git clone
â”‚       â”‚   â”œâ”€â”€ sonnet-1/    # Full git clone
â”‚       â”‚   â””â”€â”€ codex-1/     # Full git clone
â”‚       â””â”€â”€ issues/
â”‚           â””â”€â”€ 789/
â”‚               â”œâ”€â”€ specs/
â”‚               â”œâ”€â”€ context/
â”‚               â””â”€â”€ ai_docs/
â””â”€â”€ ai_docs/
    â””â”€â”€ INDEX.md             # Global ai_docs index
```

### 3.2 Agent Lifecycle

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   IDLE      â”‚ (on main, pulled)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ assigned to issue
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CHECKOUT   â”‚ (branch for issue)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WORKING   â”‚ (executing stage)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ work_complete signal
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   DONE      â”‚ (push, back to main)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ pull main
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   IDLE      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Agent Provisioning

When falcon needs an agent:
1. Check for available agent of requested type
2. If none available, provision new agent folder
3. Clone repo, checkout main, pull latest
4. Register in database

### 3.4 Git Synchronization

After any merge to main:
- All IDLE agents pull main
- Agents in WORKING state remain on their branch
- After WORKING â†’ DONE, agent pulls main before IDLE

---

## Part 4: Agent Communication API

### 4.1 Falcon API Endpoints

```
POST /api/issues/:id/comment
  { "content": "string" }

POST /api/issues/:id/stage-message
  { "to_stage": "spec_review", "message": "string" }

POST /api/issues/:id/work-complete
  { "status": "success" | "failed", "output": "string" }

GET  /api/issues/:id
  Returns issue details + stage messages for current stage

GET  /api/issues/:id/context
  Returns context pack content

GET  /api/issues/:id/spec
  Returns spec content
```

### 4.2 Agent Toolset (MCP or Custom)

Agents receive a simple toolset:

```typescript
// Tools available to agents
tools = {
  comment: (issueId: string, content: string) => void,
  stageMessage: (issueId: string, toStage: string, message: string) => void,
  workComplete: (issueId: string, status: 'success' | 'failed') => void,
  getContext: (issueId: string) => ContextPack,
  getSpec: (issueId: string) => Spec,
  getMessages: (issueId: string) => StageMessage[],
}
```

### 4.3 Agent Invocation

**Claude Code (non-interactive):**
```bash
claude -p "You are working on issue #789..." \
  --tools ./falcon-tools.json \
  --no-interactive
```

**Codex (research needed):**
- Research how to invoke Codex CLI non-interactively
- Similar pattern: provide prompt + tools + exit on completion

**Debug Mode:**
- Stream output to dashboard websocket
- Show in debug panel in real-time

**Normal Mode:**
- Suppress output
- Agent communicates via API only

---

## Part 5: Orchestrator Logic

### 5.1 State Machine

```
BACKLOG â”€â”€(human moves to todo)â”€â”€> TODO
TODO â”€â”€(human starts)â”€â”€> CONTEXT_PACK [agent_working]
CONTEXT_PACK â”€â”€(work_complete)â”€â”€> CONTEXT_REVIEW [agent_ready]
CONTEXT_REVIEW â”€â”€(work_complete)â”€â”€> SPEC [agent_working]
SPEC â”€â”€(work_complete)â”€â”€> SPEC_REVIEW [agent_ready]
SPEC_REVIEW â”€â”€(work_complete)â”€â”€> IMPLEMENT [agent_working]
IMPLEMENT â”€â”€(work_complete)â”€â”€> PR_REVIEW [agent_working]
PR_REVIEW â”€â”€(findings posted)â”€â”€> PR_HUMAN_REVIEW [needs_human_attention]
PR_HUMAN_REVIEW â”€â”€(human approves fixes)â”€â”€> FIXER [agent_working]
FIXER â”€â”€(work_complete)â”€â”€> PR_RE_REVIEW [agent_working]
PR_RE_REVIEW â”€â”€(all clear)â”€â”€> TESTING [agent_working]
TESTING â”€â”€(work_complete)â”€â”€> DOC_REVIEW [agent_working]
DOC_REVIEW â”€â”€(work_complete)â”€â”€> MERGE_READY [needs_human_attention | auto]
MERGE_READY â”€â”€(merge success)â”€â”€> DONE
MERGE_READY â”€â”€(conflict)â”€â”€> MERGE_CONFLICT [needs_human_attention]
```

### 5.2 Falcon Orchestrator Intelligence

Use Claude models for orchestrator decisions:

```typescript
// Example: Generate branch name
const branchName = await askHaiku(`
  Generate a git branch name for this issue:
  Title: ${issue.title}
  Labels: ${issue.labels.join(', ')}
  Format: type/issue-number-short-description
`);

// Example: Determine if doc update needed
const needsDocUpdate = await askHaiku(`
  Based on these changes, do the docs need updating?
  Files changed: ${changedFiles.join('\n')}
  Respond: yes or no
`);
```

---

## Part 6: Integration Points

### 6.1 GitHub Integration

- Create PR automatically at PR_REVIEW stage
- Post scout/judge findings as PR comments
- Handle merge via API
- Detect merge conflicts

### 6.2 Subscription Management

Store credentials for:
- Claude Code Max subscriptions (multiple)
- Codex Pro subscriptions (multiple)
- GitHub account

Map subscriptions to agent slots.

### 6.3 Existing Falcon Features

**Disabled for now:**
- Self-learning/injection system (re-enable once base works)

**Retained:**
- PR Review scouts/judges/orchestrator pattern
- Pattern attribution (runs after PR review)

---

## Implementation Phases

### Phase 1: Foundation (Database + Basic UI)
- [ ] Set up React + TypeScript project
- [ ] Set up Express backend with SQLite
- [ ] Implement data model with Drizzle
- [ ] Basic CRUD API for projects, issues, users
- [ ] Kanban board UI (view only)

### Phase 2: Issue Management
- [ ] Full Kanban with drag-drop
- [ ] Issue detail view with comments
- [ ] Label management
- [ ] Document attachment
- [ ] Stage message viewing

### Phase 3: Agent Infrastructure
- [ ] Agent folder provisioning
- [ ] Git clone/checkout/pull automation
- [ ] Agent registration and availability
- [ ] Large file symlink handling

### Phase 4: Agent Communication
- [ ] Falcon API server
- [ ] Agent toolset (MCP or custom)
- [ ] Claude Code non-interactive invocation
- [ ] Work complete handling

### Phase 5: Orchestration
- [ ] State machine implementation
- [ ] Automatic stage progression
- [ ] Model configuration presets
- [ ] Branch name generation

### Phase 6: Dashboard
- [ ] Active agents view
- [ ] Debug output streaming
- [ ] PR review findings display
- [ ] Human approval workflow

### Phase 7: GitHub Integration
- [ ] PR creation
- [ ] Comment posting
- [ ] Merge handling
- [ ] Conflict detection

### Phase 8: Polish
- [ ] Subscription management UI
- [ ] Project settings
- [ ] Workflow preset management
- [ ] Error handling and recovery

---

## Open Questions

1. **Codex CLI invocation**: Need to research non-interactive mode for Codex
2. **MCP vs custom tools**: Should we use MCP protocol or simpler HTTP tools?
3. **Real-time updates**: WebSocket for dashboard updates?
4. **Multi-machine**: Should agents be able to run on different machines?
5. **Persistence**: Keep agent work if Falcon restarts mid-task?

---

## File Locations

After implementation:

```
falcon-ai/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli/                    # Existing CLI (falcon init, etc.)
â”‚   â”œâ”€â”€ pm/                     # New: Project Management backend
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ orchestrator/
â”‚   â””â”€â”€ dashboard/              # New: React dashboard
â”‚       â”œâ”€â”€ components/
â”‚       â”œâ”€â”€ pages/
â”‚       â””â”€â”€ stores/
â”œâ”€â”€ specs/
â”‚   â””â”€â”€ falcon-expand-1.md      # This document
â””â”€â”€ docs/
    â””â”€â”€ design/
        â””â”€â”€ falcon-new-vision.md
```

---

## Next Steps

1. Review and approve this plan
2. Research Codex CLI non-interactive mode
3. Research ai_docs for Claude Code non-interactive streaming
4. Start Phase 1 implementation
